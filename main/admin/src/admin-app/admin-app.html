<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/iron-location/iron-location.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<dom-module id="admin-app">
  <template>
    <style is="custom-style" include="iron-flex iron-positioning iron-flex-alignment">
      :host {
        display: block;
        --primary-color: #3F51B5;
        --accent-color: #FF4081;
        @apply(--layout-fullbleed);
        @apply(--layout-fit);
      }
      paper-drawer-panel {
        --paper-drawer-panel-drawer-container: {
          background-color: #F5F5F5;
        }
      }
      paper-card {
        --paper-card: {
          @apply(--layout-vertical);
          @apply(--layout-center-center);
          width: 85%;
          margin-top: 20px;
          padding: 20px 10px;
        };
      }
      paper-tabs {
        --paper-tabs-selection-bar-color: #FFFFFF;
      }
      #page4 {
        @apply(--layout-vertical);
        @apply(--layout-fit);
        background-color: var(--google-grey-300);
        margin: 0 auto;
      }
      #page4 h1{
        color: var(--paper-grey-800);
      }
      #page4 p{
        color: var(--paper-grey-700);
        padding: 0 10%;
      }
      #page4 h1, #page4 p{
        text-align: center;
      }
    </style>

    <iron-location id="locator" dwell-time="2" hash="{{hash}}" path="{{path}}"></iron-location>

    <paper-drawer-panel force-narrow disable-edge-swipe disable-swipe id="drawerPanel">

      <div drawer>

        <div style="text-align:center" id="drawerSpinnerWrapper">
          <paper-spinner active id="drawerSpinner" style="margin: 0 auto;text-align:center;padding-top: 10px;"></paper-spinner>
          <p style="color: #757575">Loading content...</p>
        </div>

        <admin-app-drawer-content></admin-app-drawer-content>

      </div>

      <div main>

        <paper-header-panel mode="standard">

          <paper-toolbar class="medium-tall paper-header">
            <paper-icon-button icon="menu" paper-drawer-toggle title="Men&uuml; &ouml;ffnen" alt="Men&uuml; &ouml;ffnen"></paper-icon-button>
            <div class="title" style="padding-bottom: 1px;">Administration</div>
            <a href="https://gymnasium-klotzsche.de/">
              <div class="right"><img src="/raumreservierung/project/img/gykl-logo.gif" width="78px"></div>
            </a>
            <div class="bottom fit">
              <paper-tabs fit-container no-slide selected="{{selectedTab}}" scrollable id="tabs">
                <paper-tab>Nutzerverwaltung</paper-tab>
                <paper-tab>Raumverwaltung</paper-tab>
                <paper-tab>Fehlermeldungen</paper-tab>
              </paper-tabs>
            </div>
          </paper-toolbar>

          <!-- dynamic fragment-content for admins only -->
          <iron-pages id="pages" selected="{{selectedPage}}">

            <div id="page1" class="layout vertical center">
              <paper-card>
                <paper-spinner active></paper-spinner>
                <p style="color: #757575;">Loading Usermanager...<br></p>
              </paper-card>
              <admin-nutzerverwaltung id="nutzerverwaltung-origin"></admin-nutzerverwaltung>
            </div>
            <div id="page2" class="layout vertical center">
              <paper-card>
                <paper-spinner active></paper-spinner>
                <p style="color: #757575;">Loading Roommanager...<br></p>
              </paper-card>
            </div>
            <div id="page3" class="layout vertical center">
              <paper-card>
                <paper-spinner active></paper-spinner>
                <p style="color: #757575;">Loading Error-Messages...<br></p>
              </paper-card>
              <admin-error-reports></admin-error-reports>
            </div>

            <!-- Welcome Page -->
            <div id="page4">
              <h1>Willkommen!</h1>
              <p>
                Um Gebrauch von den Administratorwerkzeugen zu machen, klicken Sie einfach auf den Namen des Tools, das
                Sie verwenden wollen (Nutzerverwaltung, Raumverwaltung oder Fehlermeldungen)
              </p>
            </div>

          </iron-pages>

        </paper-header-panel>

      </div>

    </paper-drawer-panel>

  </template>

  <script>
    Polymer({

      is: 'admin-app',

      properties: {
          hash: {
              type: String,
              observer: '_onHashChange'
          },
          path: {
              type: String,
              observer: '_onPathChange'
          },
          selectedTab: {
              type: Number,
              value: 3,
              observer: '_onTabChanged'
          },
          selectedPage: {
              type: Number,
              value: 3,
              observer: '_onPageChanged'
          }
      },

      listeners: {
          'drawerPanel.iron-select':'_onPanelSelect',
          'pageLoaded':'_onPageLoad' // Custom event fired by Elements when ready :)
      },

        ready: function() {
          console.log('[admin-app] element loaded and ready');
          this.hash = this.$.locator.hash;

          if(this.selectedTab != this.selectedPage) {
              this.selectedTab = this.selectedPage;
          } else {
              // Initial Trigger for predefined selected
              this._onTabChanged();
              this._onPageChanged();

          }
        },

        _onHashChange: function(){
          var loc = this.$.locator;
        },
        _onPanelSelect: function(){
            var sel = this.$.drawerPanel.selected;
            if(sel == "drawer") {
                this.importHref('src/admin-app-drawer-content/admin-app-drawer-content.html', this._onDrawerLoad, null, true);
            }
        },
        _onDrawerLoad: function(){
            this.$.drawerSpinner.active = false;
            this.$.drawerSpinnerWrapper.style.display = "none";
        },
        _onPathChange: function(){
            if (this.path.includes('logout')) {
                window.location = '/raumreservierung/project/main/logout';
            }
        },
        _onTabChanged: function(){
            this.selectedPage = this.selectedTab;
        },
        _onPageChanged: function(){
            for(var i=0; i < this.$.tabs.items.length; i++) {
                this.$.tabs.items[i].disabled = true;
            }
            this.selectedTab = this.selectedPage;
            switch (this.selectedTab) {
                case 0:
                    this.importHref('src/admin-nutzerverwaltung/admin-nutzerverwaltung.html', this._onLoadStart, this._onPageLoadError, true);
                    break;
                case 1:
                    this.importHref('URL/TO/PAGE', this._onLoadStart, this._onPageLoadError, true);
                    break;
                case 2:
                    this.importHref('src/admin-error-reports/admin-error-reports.html', this._onLoadStart, this._onPageLoadError, true);
                    break;
            }
        },
        _onLoadStart: function() {
            for(var i=0; i < this.$.tabs.items.length; i++) {
                this.$.tabs.items[i].disabled = false;
            }
        },
        _onPageLoad: function() {

            for(var i=0; i < this.$.tabs.items.length; i++) {
                this.$.tabs.items[i].disabled = false;
            }

            switch (this.selectedPage) {
                case 0:
                    this.$.page1.querySelector('paper-card').style.display = "none";
                    break;
                case 1:
                    this.$.page2.querySelector('paper-card').style.display = "none";
                    break;
                case 2:
                    this.$.page3.querySelector('paper-card').style.display = "none";
            }
        },
        _onPageLoadError: function(){

            for(var i=0; i < this.$.tabs.items.length; i++) {
                this.$.tabs.items[i].disabled = false;
            }

            var errorObj = Object();
            errorObj.selectedPage = this.selectedPage;
            errorObj.selectedTab = this.selectedTab;

            this.fire('push', ['error loading page '+errorObj.pageName, JSON.stringify(errorObj)]);

            var errorPlain = JSON.stringify(errorObj);

            var errorText = '<p style="color: red;">Das angeforderte Element konnte nicht geladen werden oder wurde nicht gefunden.<br>Bitte &uuml;berpr&uuml;fen Sie den Pfad zu Seite '+(this.selectedPage+1)+'</b>!</p>';
            errorText += '<p style="word-break: break-all;">'+errorPlain+'</p>';

            switch (errorObj.selectedPage) {
                case 0:
                    this.$.page1.querySelector('paper-card').heading = "Fehler beim Laden der Seite!";
                    this.$.page1.querySelector('paper-card').innerHTML = errorText;
                    break;
                case 1:
                    this.$.page2.querySelector('paper-card').heading = "Fehler beim Laden der Seite!";
                    this.$.page2.querySelector('paper-card').innerHTML = errorText;
                    break;
                case 2:
                    this.$.page3.querySelector('paper-card').heading = "Fehler beim Laden der Seite!";
                    this.$.page3.querySelector('paper-card').innerHTML = errorText;
            }

        }

    });
  </script>
</dom-module>