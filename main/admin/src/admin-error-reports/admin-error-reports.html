<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/app-layout/app-grid/app-grid-style.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<!--
`admin-error-reports`
Page for managing Error-Reports
-->

<dom-module id="admin-error-reports">
  <template>
    <style include="app-grid-style">
      :host {
        display: block;
        margin: 0 auto;
        width: 100%;

        --app-grid-columns: auto;
        --app-grid-item-height: 100%;
        --app-grid-gutter: 10px;
        --app-grid-expandible-item-columns: auto;
      }

      #content {
        margin: 0 auto;
        padding: 10px 5%;
      }

      .errorCard {
        --paper-card: {
          @apply(--layout-vertical);
          @apply(--layout-flex);
          padding: 0 10px;
          word-break: break-all;
        }
      }

      ul {
        list-style: none;
        margin: 0 auto;
        padding: 0;
      }
      .item {
        min-width: 215px;
      }
      .contentCard{
        --paper-card: {
          @apply(--layout-vertical);
          @apply(--layout-flex);
        }
      }
      .card-header{
        @apply(--layout-horizontal);
      }
      .card-header-text {
        @apply(--layout-flex-auto);
      }
      .fitIcon{
        @apply(--layout-flex-none);
      }

      hr{
        border: none;
        border-bottom: 2px solid var(--google-grey-300);
        margin: 10px auto;
      }
      .deleteErrorButton {
        --paper-button: {
          background-color: var(--accent-color);
          color: white;
          @apply(--layout-horizontal);
        };
      }
      #noErrorContainer {
        background-image: url('../../img/checkmark_icon.png');
        background-repeat: no-repeat;
        background-position: 50% 60%;
        @apply(--layout-fit);
        background-color: var(--google-grey-300);
      }
      .noErrorHead {
        text-align: center;
        color: var(--paper-grey-800);
        margin: 5px auto;
      }
      .noErrorText {
        text-align: center;
        color: var(--paper-grey-700);
        font-size: 18px;
        padding: 0 20px;
      }
      @media (min-width: 800px) {
        #noErrorContainer {
          background-size: 300px;
        }
      }
      @media (max-width: 799px) {
        #noErrorContainer {
          background-size: 40%;
        }
      }
    </style>

    <div id="content">

      <iron-ajax id="dataRequest"
                 url="/raumreservierung/project/backend/toolbox/admin-ajax.php"
                 method="POST"
                 body=""
                 content-type="application/x-www-form-urlencoded"
                 handle-as="json"
                 debounce-duration="300"
                 timeout="5000"
                 last-response="{{data}}"></iron-ajax>

      <paper-dialog id="loadIndicator" style="text-align: center;" with-backdrop no-close-on-esc-key no-cancel-on-outside-click>
        <h2>Lade Inhalte...</h2>
        <paper-spinner active></paper-spinner>
      </paper-dialog>
      <paper-card id="errorbox" class="errorCard"></paper-card>

      <template is="dom-if" if="{{data.success}}">
          <template is="dom-if" if="{{data.errors}}">
            <ul class="app-grid">
              <template is="dom-repeat" items="{{data.submissions}}" as="submission">
                <li class="item">
                  <paper-card class="contentCard">
                    <div class="card-content">
                      <div class="card-header">
                      <span class="card-header-text">
                        [[submission.created]]
                        <br>
                        von "[[submission.name]][[submission.email]]"
                      </span>
                        <paper-icon-button class="fitIcon" on-click="_toggleCollapse" subid="[[submission.errorID]]" icon="expand-more"></paper-icon-button>
                      </div>
                      <iron-collapse id="collapse-[[submission.errorID]]">
                        <hr>
                        <div>Seite des Fehlers:<br>[[submission.page]]</div>
                        <br>
                        <div style="text-align: justify;">[[submission.text]]</div>
                        <br>
                        <div class="card-actions">

                          <paper-button class="deleteErrorButton" on-click="deleteError" subid="[[submission.errorID]]">
                            <iron-icon icon="delete" style="margin-right: 10px;"></iron-icon>
                            LÃ–SCHEN
                          </paper-button>

                        </div>

                      </iron-collapse>
                    </div>
                  </paper-card>
                </li>
              </template>
            </ul>
          </template>
          <template is="dom-if" if="{{!data.errors}}">
            <div id="noErrorContainer">
              <br>
              <h1 class="noErrorHead">Hurra!</h1>
              <p class="noErrorText">Es sind keine Fehlermeldungen vorhanden :)</p>
            </div>
          </template>
      </template>

      <template is="dom-if" if="{{!data.success}}">
        <paper-card heading="Fehler bei der Anfrage!" class="errorCard">
          <p>
            Der Server hat einen Fehler gemeldet:<br>
            <span style="color: red;">
              {{data.message}}
            </span>
          </p>
        </paper-card>
      </template>

    </div>

  </template>

  <script>

    var loaded = Object();

    Polymer({

      is: 'admin-error-reports',

        listeners: {
            'dataRequest.request':'_onRequest',
            'dataRequest.response':'_onResponse',
            'dataRequest.error':'_onAjaxError'
        },

      properties: {
        data: {
          type: Object,
          observer: '_onResponse'
        },
        page: {
            type: Number,
            value: 1,
            observer: '_onPageChange'
        }
      },

        ready: function() {
          this.fire('pageLoaded');
          console.log('[admin-error-reports] element loaded and ready');

          this.$.dataRequest.body = "request=getErrors";
          this.$.dataRequest.timeout = 5000;
          this.$.dataRequest.generateRequest();
        },
        _onRequest: function() {

          this.$.loadIndicator.center();
          this.$.loadIndicator.open();
          this.$.errorbox.innerHTML = "";

        },
        _onResponse: function() {

          this.data = this.$.dataRequest.lastResponse;
          this.$.loadIndicator.close();
          this.$.errorbox.innerHTML = "";

        },
        _onAjaxError: function(e) {

          this.$.loadIndicator.close();
          this.$.errorbox.innerHTML = "Es ist ein Skriptfehler aufgetreten:<br>"+e.detail;

        },
        _onPageChange: function() {
          this.$.dataRequest.body = "request=getErrors&page="+this.page;
        },
        _toggleCollapse: function(e) {
            // Dirty but works, decides whether clicked on the paper-icon-button - wrapper or the icon itself :)
            var type = (e.path[2].nodeName == "PAPER-ICON-BUTTON") ? 2 : 0;
            id = e.path[type].subid;
            this.$$('#collapse-'+id).toggle();
            if(this.$$('#collapse-'+id).opened) {
                e.path[type].icon = "expand-less";
            } else {
                e.path[type].icon = "expand-more";
            }
        },
        deleteError: function(e) {
          //Same as in this._toggleCollapse
          var id = (e.path[0].nodeName == "PAPER-BUTTON") ? e.path[0].subid : e.path[3].subid;
          var ajax = this.$.dataRequest;
          ajax.body = "request=deleteError&id="+id;
          ajax.generateRequest();
        }

    });
  </script>
</dom-module>
