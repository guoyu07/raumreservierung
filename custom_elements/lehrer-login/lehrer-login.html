<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Raumreservierung - Lehrer - Login</title>
    <link rel="import" href="../../bower_components/polymer/polymer.html">
</head>
<body>


<dom-module id="lehrer-login">

    <template>

        <style is="custom-style">
            paper-input{
                max-width: 300px;
                margin: 0 auto;
                --paper-input-container-color: #757575;
                --paper-input-container-focus-color: #607D8B;
            }
            paper-button{
                --paper-button:{
                    @apply(--layout-horizontal);
                    @apply(--layout-center-center);
                    background-color: #607D8B;
                    color: white;
                }
            }
        </style>

        <paper-material elevation="1" class="autopadding">

            <h1 class="center">Log-in f&uuml;r Lehrer</h1>
            <br>
            <paper-input label="Benutzername" type="text"
                         id="nameInput" pattern="[A-Za-z0-9]*" required maxlength="24"
                         error-message="Bitte &uuml;berpr&uuml;fen Sie Ihre Eingaben!"
                         auto-validate></paper-input>
            <paper-input label="Passwort" type="password" id="pwInput"
                         required maxlength="32" error-message="Bitte &uuml;berpr&uuml;fen Sie Ihre Eingaben!"
                         auto-validate></paper-input>
            <br>
            <div style="max-width: 300px" class="contentcenter center"><!-- Button-Wrapper for button to be centered -->
                <paper-button raised id="loginButton">Anmelden</paper-button>
                <br>
                <paper-spinner-lite id="spinner"></paper-spinner-lite>
                <div id="errorBox" style="color: red;"></div>
            </div>

        </paper-material>

    </template>

    <script>
        HTMLImports.whenReady(function(){
            Polymer({
                is: 'lehrer-login',
                listeners:{
                    'loginButton.tap': 'logIn'
                },

                ready: function(){
                    //READY FUNCTION
                },
                logIn: function(){
                    var nameInp = this.$.nameInput;
                    var pwInp = this.$.pwInput;

                    if(nameInp.validate() === true && nameInp.value != "" && pwInp.validate() === true && pwInp.value != ""){
                        this.ajaxLogin(nameInp.value, pwInp.value);
                    }
                },
                ajaxLogin: function(name, pw){
                    var xhr = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject("Microsoft.XMLHTTP");
                    xhr.open("POST", "/raumreservierung/project/backend/accountsystem/ajaxLoginRequest.php");
                    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                    var spinner = document.getElementById('spinner');
                    var button = document.getElementById('loginButton');
                    var errorBox = document.getElementById('errorBox');

                    xhr.timeout = 3000; //Timeout after 3 Seconds

                    xhr.onloadstart = function(){
                        spinner.active = true;
                        button.disabled = true;
                        errorBox.innerHTML = "";
                    };

                    xhr.onload = function(){
                        spinner.active = false;
                        button.disabled = false;
                        errorBox.innerHTML = "";

                        if(this.responseText){
                            var r = JSON.parse(this.responseText);
                            if(r.success !== true){
                                errorBox.innerHTML = r.message;
                            } else {

                                var type;

                                if(r.type == 1){
                                    type = "admin";
                                } else if(r.type == 2) {
                                    type = "management";
                                } else if(r.type == 3) {
                                    type = "teacher";
                                }

                                window.location = "./main/"+type;
                            }
                        } else {
                            errorBox.innerHTML = "Es ist ein Fehler bei der Anfrage aufgetreten.<br>" +
                                "Bitte versuchen Sie es erneut oder<br>" +
                                "kontaktieren Sie einen Administrator.";
                        }
                    };

                    xhr.ontimeout = function(){
                        spinner.active = false;
                        button.disabled = false;
                        errorBox.innerHTML = "Die Verbindung zum Server hat zu lange gedauert.<br>" +
                            "Bitte &uuml;berpr&uuml;fen Sie Ihre Internetverbindung!";
                    };

                    xhr.send("name="+name+"&pw="+pw);
                }

            });
        });
    </script>


</dom-module>

<lehrer-login></lehrer-login>

</body>
</html>