<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">

<dom-module id="reporting-form">

    <template>

        <style is="custom-style">
            :host{
                @apply(--layout-vertical);
                @apply(--layout-center);
            }
            paper-card {
                --paper-card: {
                    @apply(--layout-vertical);
                    @apply(--layout-center);
                    margin-top: 20px;
                }
            }
            paper-checkbox {
                --paper-checkbox-checked-color: #689F38;
            }
            paper-input {
                width: auto;
                --paper-input-container-focus-color: #689F38;
            }
            paper-button {
                @apply(--layout-horizontal);
                @apply(--layout-center);
                --paper-button: {
                    background-color: #607D8B;
                    color: white;
                }
            }
            paper-spinner-lite {
                @apply(--layout-horizontal);
                @apply(--layout-center-center);
                padding: 10px;
                display: none;
            }
            paper-textarea {
                --paper-input-container-focus-color: #689F38;
            }
        </style>

        <iron-ajax id="sendReport"
                   url="/raumreservierung/project/backend/toolbox/sendError.php"
                   method="POST"
                   content-type="application/x-www-form-urlencoded"
                   handle-as="json"
                   debounce-duration="300"
                   timeout="5000"></iron-ajax>

        <paper-card heading="Kontaktformular" style="padding-bottom: 8px;">

            <div class="card-content">

                <paper-input id="dynamicInput" label="" allowed-pattern="[A-Za-z0-1.-_ÖöÄäÜüß@~:;,]" auto-validate required></paper-input>
                <paper-input id="linkInput" label="Seite des Fehlers" maxlength="42" error-message="Bitte Eingaben &uuml;berpr&uuml;fen!" allowed-pattern="[A-Za-z0-9_\-#/?=]"><div prefix>.../raumreservierung/project/</div></paper-input>
                <paper-textarea id="descInput" label="Erkl&auml;rung des Fehlers" prevent-invalid-input required auto-validate error-message="Bitte &uuml;berpr&uuml;fen Sie Ihre Eingaben!" rows="2" max-rows="6" type="text" char-counter maxlength="4096"></paper-textarea>

                <div id="errorBox" style="margin-top: 26px; text-align: center; color: red;"></div>

            </div>

            <div class="card-actions">
                <paper-button id="sendButton">Absenden</paper-button>
            </div>

            <paper-spinner-lite active id="spinner"></paper-spinner-lite>

        </paper-card>

    </template>

    <script>

        HTMLImports.whenReady(function(){
            Polymer({
                is: 'reporting-form',
                properties: {
                    name: String,
                    loggedin: Number
                },

                listeners: {
                    'sendButton.tap': 'sendErrorReport',
                    'sendReport.request': '_onRequest',
                    'sendReport.response': '_onResponse',
                    'sendReport.timeout': '_onTimeout'
                },

                ready: function(){
                    this.updateInput();
                },
                updateInput: function(){
                    if(this.loggedin == true) {
                        var i = this.$.dynamicInput;
                        i.value = this.name;
                        i.label = "Benutzername";
                        i.errorMessage = "Bitte Namen überprüfen!";
                        i.type = "text";
                        i.minlength = 4;
                        i.maxlength = 32;
                        i.charCounter = true;
                        i.disabled = true;
                    } else {
                        var i = this.$.dynamicInput;
                        i.value = "";
                        i.label = "E-Mail - Adresse";
                        i.errorMessage = "Bitte E-Mail überprüfen!";
                        i.type = "email";
                        i.minlength = 5;
                        i.maxlength = 64;
                        i.charCounter = true;
                    }
                },

                sendErrorReport: function(){
                    var dyn = this.$.dynamicInput;
                    var page = this.$.linkInput;
                    var desc = this.$.descInput;

                    if(dyn.validate() && page.validate() && desc.validate()) {
                        if(this.loggedin) {
                            var body = "request=sendError&name="+dyn.value+"&msg="+desc.value+"&page="+page;
                        } else {
                            if(this.checked == true) {
                                var body = "request=sendError&name="+dyn.value+"&msg="+desc.value+"&page="+page;
                            } else {
                                var body = "request=sendError&email="+dyn.value+"&msg="+desc.value+"&page="+page;
                            }
                        }
                    }

                    this.$.sendReport.body = body;
                    this.$.sendReport.generateRequest();

                },

                _onRequest: function(){
                    this.$.sendButton.disabled = true;
                    this.$.spinner.style.display = "block";
                    this.$.errorBox.innerHTML = '';
                },
                _onResponse: function(){
                    this.$.sendButton.disabled = false;
                    this.$.spinner.style.display = "none";
                    //TODO: Handle Response JSON
                },
                _onTimeout: function(){
                    this._onResponse();
                    this.$.errorBox.innerHTML = '<span style="color: red;">Die Verbindung zum Server hat zu lange gedauert!<br>Bitte &uuml;berpr&uuml;fen Sie Ihre Internetverbindung!</span>'
                }

            });
        });

    </script>

</dom-module>