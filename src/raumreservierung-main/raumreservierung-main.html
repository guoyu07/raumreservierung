<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-location/iron-location.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="raumreservierung-main">
  <template>
    <style>
      :host {
        display: block;
        margin: 0 auto;
        --primary-color: #8BC34A;
        --accent-color: #607D8B;
        color: #212121;
      }
      #loadIndicator {
        @apply(--layout-center-center);
        margin: 0 auto;
        text-align: center;
      }
      .spinnerWrapper {
        text-align: center;
      }
      a {
        text-decoration: none;
        color: #212121;
      }
    </style>

    <iron-location hash="{{hash}}"></iron-location>

    <paper-dialog id="loadIndicator" with-backdrop no-cancel-on-esc-key no-cancel-on-outside-click>
      <h2>Inhalte werden geladen...</h2>
      <br>
      <div class="spinnerWrapper"><paper-spinner active></paper-spinner></div>
      <br>
      <p><i>Der erste Ladevorgang kann bei schlechten Internetverbindungen eine Weile dauern. Bitte haben Sie einen Moment Geduld.</i></p>
    </paper-dialog>

    <paper-dialog id="errorDialog" with-backdrop>
      <div id="errorContent">

      </div>
      <p style="text-align: center"><i>Bitte melden Sie diesen Fehler einem Administrator!</i></p>
      <div class="buttons">
        <paper-button dialog-confirm autofocus style="color: #F44336;">OK</paper-button>
      </div>
    </paper-dialog>

    <iron-ajax id="userDataRequest"
               url="../../backend/api/main-ajax.php"
               method="POST"
               content-type="application/x-www-form-urlencoded"
               handle-as="json"
               timeout="5000"
               debounce-duration="300"
               last-response="{{response}}"></iron-ajax>

    <iron-pages id="pages" selected="{{selected}}">

      <!-- Main Start Page -->
      <raumreservierung-landingpage response="{{response}}"></raumreservierung-landingpage>
      <!-- E-Mail Confirmation -->
      <raumreservierung-email-confirmation></raumreservierung-email-confirmation>

    </iron-pages>

  </template>

  <script>
    Polymer({

        is: 'raumreservierung-main',

        properties: {
            hash: {
                type: String,
                observer: '_onHashChange'
            },
            selected: Number,
            response: Object
        },

        listeners: {
            'push':'_pushToLog',
            'pageLoad': '_onComponentLoaded',
            'userDataRequest.request':'_onRequest',
            'userDataRequest.response':'_onResponse',
            'userDataRequest.error':'_onError'
        },

        ready: function() {
            this.fire('pageLoad', this.nodeName);

            this.$.userDataRequest.body = "r=getSessionData";
            this.$.userDataRequest.generateRequest();
        },
        _onRequest: function() {
            this.$.loadIndicator.center();
            this.$.loadIndicator.open();
        },
        _onResponse: function() {
            this.$.loadIndicator.close();
            this.response = this.$.userDataRequest.lastResponse;
            this.loggedin = (this.response.data) ? this.response.data.loggedin : false;
            if(this.loggedin === true)
                this._redirect();
            else
                this._loadPages();
        },
        _onError: function() {
            this.$.loadIndicator.close();
        },
        _onHashChange: function() {
            switch(this.hash){
                case "index":
                    this.hash = "";
                    window.location.reload();
                    break;
                case "confirm-email":
                    this.$.pages.select(1);
                    this.loadEmailPage();
                    break;
                default:
                    this.$.pages.select(0);
            }
        },
        _pushToLog: function(e) {
            if (e.detail[0] && e.detail[1])
                console.log("["+e.detail[0]+"] "+e.detail[1]);
        },
        loadMainPage: function() {
            this.$.loadIndicator.open();
            this.importHref('src/raumreservierung-landingpage/raumreservierung-landingpage.html', this._onLandingpageLoad, this._onLandingpageLoadError, true);
        },
        _onLandingpageLoad: function() {
            this.$.pages.select(0);
            this.$.loadIndicator.close();
        },
        _onLandingpageLoadError: function() {
            this.$.loadIndicator.close();
            this.$.errorContent.innerHTML = '<p style="color:red;">Die Startseite konnte nicht geladen werden!</p>';
            this.$.errorDialog.center();
            this.$.errorDialog.open();
        },
        _loadPages: function() {
            switch(this.selected){
                case 0:
                    this.loadMainPage();
                    this.$.pages.select(0);
                    break;
                case 1:
                    this.loadEmailPage();
                    this.$.pages.select(1);
                    break;
                default:
                    this.loadMainPage();
                    this.$.pages.select(0);
                    break;
            }
        },
        loadEmailPage: function() {
            this.$.loadIndicator.open();
            this.importHref('src/raumreservierung-email-confirmation/raumreservierung-email-confirmation.html', this._onEmailLoaded, this._onEmailLoadError, true);
        },
        _onEmailLoadError: function(){
            this.$.loadIndicator.close();
            this.$.errorContent.innerHTML = '<p style="color: red;">Die Seite f&uuml;r die E-Mail - Best&auml;tigung konnte nicht geladen werden!</p>';
            this.$.errorDialog.center();
            this.$.errorDialog.open();
        },
        _onEmailLoaded: function() {
            this.$.loadIndicator.close();
        },
        _onComponentLoaded: function(e) {
            console.log("["+e.detail+"] component loaded and ready");
        },
        _redirect: function() {
            this.$.loadIndicator.open();

            switch(this.response.data.type){
                case "1":
                    window.location = "main/admin/";
                    break;
                case "2":
                    window.location = "main/management";
                    break;
                case "3":
                    window.location = "main/teacher";
                    break;
                default:
                    this.$.loadIndicator.close();
                    this.$.errorContent.innerHTML = '<p style="color:red;">Der Typ Ihres Accounts konnte nicht ermittelt werden!</p>';
                    this.$.errorDialog.center();
                    this.$.errorDialog.open();
                    this._loadPages();
                    break;
            }
        }
    });
  </script>
</dom-module>
