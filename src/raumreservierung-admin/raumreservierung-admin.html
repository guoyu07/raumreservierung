<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">

<dom-module id="raumreservierung-admin">
  <template>
    <style is="custom-style" include="iron-flex iron-positioning iron-flex-alignment">
      :host {
        display: block;
        --primary-color: #3F51B5;
        --accent-color: #FF4081;
        @apply(--layout-fullbleed);
        @apply(--layout-fit);
      }
      paper-drawer-panel {
        --paper-drawer-panel-drawer-container: {
          background-color: #F5F5F5;
        }
      }
      paper-card {
        --paper-card: {
          @apply(--layout-vertical);
          @apply(--layout-center-center);
          width: 85%;
          margin-top: 20px;
          padding: 20px 10px;
        };
      }
      paper-tabs {
        --paper-tabs-selection-bar-color: #FFFFFF;
      }
      .welcome {
        @apply(--layout-vertical);
        @apply(--layout-fit);
        background-color: var(--google-grey-300);
        margin: 0 auto;
      }
      .welcome h1{
        color: var(--paper-grey-800);
      }
      .welcome p{
        color: var(--paper-grey-700);
        padding: 0 10%;
      }
      .welcome h1, .welcome p{
        text-align: center;
      }
      .paper-item-link {
        color: inherit;
        text-decoration: none;
      }
      paper-icon-item {
        --paper-item: {
          background-color: #F5F5F5;
        }
      }
      paper-menu {
        background-color: #F5F5F5;
      }
      paper-icon-item:hover {
        cursor: pointer;
      }
      .navHeader {
        color: #212121;
        font-size: 22px;
        margin: 0 auto;
        text-align: center;
        padding: 5px 0;
        width: auto;
        text-decoration: none;
      }
      .spinnerWrapper {
        text-align: center;
      }
      paper-toolbar[hidden] {
        display: none;
      }
    </style>

    <app-location route="{{route}}" use-hash-as-path></app-location>
    <app-route
        route="{{route}}"
        pattern=":view"
        data="{{viewData}}"
        tail="{{viewTail}}"></app-route>

    <paper-dialog id="loadIndicator" with-backdrop no-cancel-on-esc-key no-cancel-on-outside-click>
      <h2>Inhalte werden geladen...</h2>
      <br>
      <div class="spinnerWrapper"><paper-spinner active></paper-spinner></div>
      <br>
      <p><i>Der erste Ladevorgang kann bei schlechten Internetverbindungen eine Weile dauern. Bitte haben Sie einen Moment Geduld.</i></p>
    </paper-dialog>

    <paper-dialog id="errorDialog" with-backdrop>
      <div id="errorContent">

      </div>
      <div class="buttons">
        <paper-button dialog-confirm autofocus style="color: #F44336;">OK</paper-button>
      </div>
    </paper-dialog>

    <paper-drawer-panel force-narrow disable-edge-swipe disable-swipe id="drawerPanel">

      <div drawer>

        <paper-toolbar style="background-color: white; border-bottom: 1px solid #E0E0E0;">
          <paper-icon-button icon="arrow-back" paper-drawer-toggle style="color: #212121;"></paper-icon-button>
          <div class="title navHeader">Navigation</div>
        </paper-toolbar>

        <paper-menu>
          <a href="../../account" target="_self" class="paper-item-link">
            <paper-icon-item>
              <iron-icon icon="account-circle" item-icon></iron-icon>
              <paper-item-body two-line>
                <div>Mein Account</div>
                <div secondary>Verwaltung Ihres Profils</div>
              </paper-item-body>
            </paper-icon-item>
          </a>
            <paper-icon-item id="logoutButton">
              <iron-icon icon="power-settings-new" item-icon></iron-icon>
              <paper-item-body two-line>
                <div>Ausloggen</div>
                <div secondary>Abmelden und zur Startseite</div>
              </paper-item-body>
            </paper-icon-item>
          <a href="../../imprint" target="_self" class="paper-item-link">
            <paper-icon-item>
              <iron-icon icon="gavel" item-icon></iron-icon>
              <paper-item-body two-line>
                <div>Impressum</div>
                <div secondary>Impressum &amp; Urheberrecht</div>
              </paper-item-body>
            </paper-icon-item>
          </a>

        </paper-menu>

      </div>

      <div main>

        <paper-header-panel mode="standard">

          <paper-toolbar class="medium-tall paper-header" hidden$="[[frameLayout]]">
            <paper-icon-button icon="menu" paper-drawer-toggle title="Men&uuml; &ouml;ffnen" alt="Men&uuml; &ouml;ffnen"></paper-icon-button>
            <div class="title" style="padding-bottom: 1px;">Administration</div>
            <a href="https://gymnasium-klotzsche.de/" target="_self">
              <div class="right"><img src="../../img/gykl-logo.gif" width="78px"></div>
            </a>
            <div class="bottom fit">
              <paper-tabs fit-container no-slide selected="{{viewData.view}}" scrollable id="tabs" attr-for-selected="name">
                <paper-tab name="usermanagement">Nutzerverwaltung</paper-tab>
                <paper-tab name="roommanagement">Raumverwaltung</paper-tab>
                <paper-tab name="error-reports">Fehlermeldungen</paper-tab>
                <paper-tab name="cronjobs">Cronjob-Logs</paper-tab>
              </paper-tabs>
            </div>
          </paper-toolbar>

          <!-- dynamic fragment-content for admins only -->
          <iron-pages id="adminPages" selected="{{viewData.view}}" attr-for-selected="name" fallback-selection="welcome">

            <div id="page1" class="layout vertical center" name="usermanagement">
              <admin-nutzerverwaltung id="nutzerverwaltung-origin"></admin-nutzerverwaltung>
            </div>
            <div id="page2" class="layout vertical center" name="roommanagement">
              <admin-raumverwaltung></admin-raumverwaltung>
            </div>
            <div id="page3" class="layout vertical center" name="error-reports">
              <admin-error-reports id="errorreport-origin"></admin-error-reports>
            </div>

            <div id="page4" class="layout vertical center" name="cronjobs">
              <admin-cronjobs></admin-cronjobs>
            </div>

            <!-- Welcome Page -->
            <div id="page5" class="welcome" name="welcome">
              <h1>Willkommen!</h1>
              <p>
                Um Gebrauch von den Administratorwerkzeugen zu machen, klicken Sie einfach auf den Namen des Tools, das
                Sie verwenden wollen (Nutzerverwaltung, Raumverwaltung oder Fehlermeldungen)
              </p>
            </div>

          </iron-pages>

        </paper-header-panel>

      </div>

    </paper-drawer-panel>

  </template>

  <script>
    Polymer({

      is: 'raumreservierung-admin',

      properties: {
          frameLayout: {
              type: Boolean,
              value: function() {
                  if(this.viewData)
                      return this.viewData.view == "roommanagement";
                  else
                      return false;
              }
          },
          urlPrefix: {
              type: String,
              value: function() {
                  var path = window.location.pathname;
                  var list = path.split('/');

                  /** Remove last Part of the string until the next "/" */
                  list.pop();

                  return list.join('/');
              }
          }
      },

      observers: [
          '_onPageChanged(viewData.view)'
      ],

      listeners: {
          'pageLoaded':'_onPageLoad', // Custom event fired by Elements when ready :)
          'logoutButton.tap': '_onLogoutRequest',
          'admin-page-session-error': '_onLogoutRequest',    // Fired by custom elements when session data is invalid
          'admin-reset-pages': 'customResetPages',
          'close-frame': '_onLayoutClose'
      },

        ready: function() {
          this.fire('pageLoad', this.nodeName);
          window.location.hash = this.viewData.view;
        },
        _onPageChanged: function(){
            this.$.loadIndicator.open();
            // Lock Tabs
            for(var i=0; i < this.$.tabs.items.length; i++) {
                this.$.tabs.items[i].disabled = true;
            }

            var _switchPage = function() {
                switch (this.viewData.view) {
                    case "usermanagement":
                        this.importHref('src/raumreservierung-admin/src/admin-nutzerverwaltung/admin-nutzerverwaltung.html', this._onLoadStart, this._onPageLoadError, true);
                        break;
                    case "roommanagement":
                        this.importHref('src/raumreservierung-admin/src/admin-raumverwaltung/admin-raumverwaltung.html', this._onLoadStart, this._onPageLoadError, true);
                        break;
                    case "error-reports":
                        this.importHref('src/raumreservierung-admin/src/admin-error-reports/admin-error-reports.html', this._onLoadStart, this._onPageLoadError, true);
                        break;
                    case "cronjobs":
                        this.importHref('src/raumreservierung-admin/src/admin-cronjobs/admin-cronjobs.html', this._onLoadStart, this._onPageLoadError, true);
                        break;
                    case "welcome":
                        this._freeTabs();
                        break;
                }
                this.frameLayout = (this.viewData.view == "roommanagement");
                console.log(this.frameLayout, this.viewData.view);
            }.bind(this);

            if('onLine' in navigator) {
                if(navigator.onLine) {
                    _switchPage();
                } else {
                    this._freeTabs();
                    this.$.loadIndicator.close();
                    this.$.errorContent.innerHTML = '<p style="color: red;">Es konnte keine Verbindung zum Server hergestellt werden.<br>Bitte überprüfen Sie Ihre Internetverbindung!</p>';
                    this.$.errorDialog.open();
                }
            } else {
                _switchPage();
            }
        },
        _freeTabs: function() {
            this.$.loadIndicator.close();
            for(var i=0; i < this.$.tabs.items.length; i++) {
                this.$.tabs.items[i].disabled = false;
            }
        },
        _onLoadStart: function() {
            this._freeTabs();
            var e;
            switch(this.viewData.view){
                case "usermanagement":
                    // Trigger Data Reload on Tab Change if error on initial load
                    e = this.$$('admin-nutzerverwaltung');
                    if(e)
                        e.reloadData = true;
                    break;
                case "roommanagement":
                    // Room reservation not implemented yet
                    break;
                case "error-reports":
                    // Trigger Data Reload on Tab Change if error on initial load
                    e = this.$$('admin-error-reports');
                    if(e)
                        e.reloadData = true;
                    break;
                case "cronjobs":
                    e = this.$$('admin-cronjobs');
                    if(e)
                        e.reloadData();
                    break;
            }
        },
        _onPageLoad: function() {
            this._freeTabs();
        },
        _onPageLoadError: function(){
            this._freeTabs();

            this.fire('push', 'Fehler beim Laden der Seite "'+this.viewData.view+'"');

            var errorText = '<p style="color: red;">Das angeforderte Element konnte nicht geladen werden oder wurde nicht gefunden.<br>Bitte &uuml;berpr&uuml;fen Sie den Pfad zu Seite '+(this.selectedPage+1)+'</b>!</p>';
            errorText += '<p style="word-wrap: break-word;">"'+this.viewData.view+'"</p>';

            switch (this.viewData.view) {
                case "usermanagement":
                    this.$.errorContent.innerHTML = errorText;
                    break;
                case "roommanagement":
                    this.$.errorContent.innerHTML = errorText;
                    break;
                case "error-reports":
                    this.$.errorContent.innerHTML = errorText;
                    break;
                case "cronjobs":
                    this.$.errorContent.innerHTML = errorText;
                    break;
            }

            this.$.errorDialog.open();

        },
        _onLogoutRequest: function() {
            this.fire('push', [this.nodeName, "logout triggered"]);
            this.$$('#nutzerverwaltung-origin').reset = true;
            this.$$('#errorreport-origin').reset = true;
            this.viewData.view = "welcome";
            this.$.drawerPanel.closeDrawer();

            /**
             * Reset Hash, because the main page doesn't
             * use it and it is very disattracting :)
             */
            window.location.hash =  "";

            this.fire('logout');
        },
        customResetPages: function() {
            this.viewData.view = "welcome";
            /**
             * We unfortunately have to reset the url here, because it doesn't get
             * set when just changing or selecting another page via native Script
             */
            window.location.hash = "welcome";
        },
        _onLayoutClose: function() {
            this.frameLayout = false;
            this.customResetPages();
        }
    });
  </script>
</dom-module>